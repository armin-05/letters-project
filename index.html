<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Desktop</title>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<style>
  :root {
    --bg-black: #000;
    --note-bg: #d3d3d3;
    --note-top: #8c8c8c;
    --green-exact: #1e7f34;
    --green-case: #9cff8a;
    --yellow-wrong: #ffeb66;
  }

  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg-black);
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
  }

  /* Desktop Icons */
  .desktop-icon {
    position: absolute;
    width: 70px;
    height: 80px;
    cursor: grab;
  }
  .desktop-icon.dragging { cursor: grabbing; }
  #icon { top: 100px; left: 100px; }
  #noteIcon { top: 100px; left: 200px; }

  /* Window Base Styles */
  .window {
    position: absolute;
    border-radius: 8px;
    overflow: hidden;
    display: none;
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  }

  .window-topbar {
    position: absolute;
    top: 0;
    left: 0;
    height: 40px;
    width: 100%;
    cursor: grab;
    z-index: 10;
  }
  .window-topbar.dragging { cursor: grabbing; }

  .window-close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    background: transparent;
    cursor: pointer;
    border: none;
    outline: none;
    z-index: 20;
  }

  /* KakaoTalk Window */
  #kakaoWindow {
    top: 200px;
    left: 200px;
  }
  #kakaoWindow .window-topbar { background: transparent; }
  #kakaoImage {
    display: block;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
  }

  /* Kakao Message Area */
  #messageContainer {
    position: absolute;
    top: 115px;
    left: 10px;
    right: 10px;
    bottom: 147px;
    overflow-y: auto;
    z-index: 5;
  }

  .messageContainer {
    display: flex;
    margin-bottom: 4px;
  }
  .userMsg { justify-content: flex-end; }
  .botMsg { justify-content: flex-start; }

  .message {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 12px;
    margin: 4px 0;
    max-width: 70%;
    word-wrap: break-word;
    font-size: 14px;
  }
  .userMsg .message {
    background-color: #ffeb00;
    color: black;
  }
  .botMsg .message {
    background-color: #ececec;
    color: black;
  }

  /* Kakao Input Area */
  #typingArea {
    position: absolute;
    left: 10px;
    bottom: 65px;
    width: calc(100% - 90px);
    height: 70px;
    font-size: 15px;
    color: black;
    background: transparent;
    border: none;
    outline: none;
    resize: none;
    z-index: 15;
  }

  #sendButton {
    position: absolute;
    right: 15px;
    bottom: 16px;
    width: 60px;
    height: 30px;
    font-weight: bold;
    color: black;
    background-color: #c0c0c0;
    border: none;
    border-radius: 4px;
    cursor: not-allowed;
    z-index: 16;
    transition: background-color .2s;
  }
  #sendButton.active {
    background-color: #ffeb00;
    cursor: pointer;
  }

  /* Note Window */
  #noteWindow {
    top: 220px;
    left: 420px;
    width: 520px;
    height: 420px;
    background: var(--note-bg);
    min-width: 260px;
    min-height: 180px;
  }
  #noteWindow .window-topbar {
    height: 36px;
    background: var(--note-top);
  }
  #noteWindow .window-close-btn {
    width: 22px;
    height: 22px;
    background: #d94c4c;
    border-radius: 50%;
    top: 6px;
  }

  #noteContent {
    position: absolute;
    top: 44px;
    left: 10px;
    right: 10px;
    bottom: 10px;
    padding: 6px;
    box-sizing: border-box;
    font-family: monospace;
    font-size: 16px;
    line-height: 1.3;
    outline: none;
    background: transparent;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow: auto;
  }

  .resize-handle {
    position: absolute;
    right: 8px;
    bottom: 8px;
    width: 14px;
    height: 14px;
    background: radial-gradient(circle, #777 30%, transparent 31%);
    border-radius: 50%;
    cursor: nwse-resize;
    z-index: 60;
  }

  /* Highlight Classes */
  .match-exact {
    background: var(--green-exact);
    color: #fff;
    transition: background-color .3s;
  }
  .match-case {
    background: var(--green-case);
    color: #000;
    transition: background-color .3s;
  }
  .match-wrong {
    background: var(--yellow-wrong);
    color: #000;
  }
</style>
</head>
<body>

<!-- Desktop Icons -->
<img id="icon" class="desktop-icon" src="Screenshot 2025-10-15 144240.png" alt="Kakao Icon">
<img id="noteIcon" class="desktop-icon" src="notepad.png" alt="Note Icon">

<!-- KakaoTalk Window -->
<div id="kakaoWindow" class="window">
  <div class="window-topbar"></div>
  <button class="window-close-btn" title="close"></button>
  <img id="kakaoImage" src="Screenshot 2025-10-15 144717.png" alt="Kakao Window">
  <div id="messageContainer"></div>
  <textarea id="typingArea" placeholder="" spellcheck="false"></textarea>
  <button id="sendButton">Send</button>
</div>

<!-- Note Window -->
<div id="noteWindow" class="window">
  <div class="window-topbar"></div>
  <button class="window-close-btn" title="close"></button>
  <div id="noteContent" contenteditable="true" aria-label="Note editor"></div>
  <div class="resize-handle" title="resize"></div>
</div>

<script>
'use strict';

// ============================================================================
// CONSTANTS & STATE
// ============================================================================

const TARGET_TEXT = `Chapter 151: Demonic nature "What?" Gu Yue Yao Le was shocked when she heard this. Fang Yuan had already struck at lightning speed, his hand chopping her neck! She fainted immediately. The young girl fell down helplessly, and Fang Yuan's hand quickly moved, holding her by the waist. Next, he activated the Stealth Scale Gu, and their bodies vanished on the spot. When Gu Yue Yao Le woke up in a sleepy state, she found herself in a dark mountain cave. She shrugged her head, trying to stand up subconsciously. But she soon found out that her arms were tied behind her back, the rope looped around her neck; she was tied tightly on a large rock. All the Gu worms on her body had been plundered away by Fang Yuan, refined and turned into his. She was merely a fifteen-year-old young girl â€” with that frail body, how could she break free from that thick ropes wrapped a few times around the rock, even tied with knots? Being trapped in this remote and unfamiliar place, the young girl started to feel frightened. She thought about the moment before she had fainted; even the most naive person would also know that Fang Yuan was going to do something bad to her.`;

const BOT_RESPONSES = [
  { pattern: "hello", reply: "Heyyyyy" },
  { pattern: "hi", reply: "hiiiiiii! " },
  { pattern: "how are you", reply: "I'm goooooood" },
  { pattern: "bye", reply: " " },
  { pattern: "thanks", reply: "You're welcomee" },
  { pattern: "weather", reply: "I hope its sunny today " },
  { pattern: "good", reply: "thats nice" },
  { pattern: "sad", reply: "Oh nooo" },
  { pattern: "angry", reply: "..." },
];

const DEFAULT_REPLIES = [
  "sorry, i just woke up. im sooo tired today",
  "i fell asleep again. wyd?",
  "Really? im soooo hungry tho",
  "do you still love me?",
  "sorry, fell asleep"
];

let zIndexCounter = 100;
const greenTimers = new WeakMap();
const kakaoState = { savedText: "", messages: [] };

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function bringToFront(elem) {
  elem.style.zIndex = ++zIndexCounter;
}

function placeCaretAtEnd(el) {
  el.focus();
  const range = document.createRange();
  range.selectNodeContents(el);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

// ============================================================================
// DRAG FUNCTIONALITY
// ============================================================================

class DragHandler {
  constructor(element, handle = element) {
    this.element = element;
    this.handle = handle;
    this.isDragging = false;
    this.offsetX = 0;
    this.offsetY = 0;
    
    this.onMouseDown = this.onMouseDown.bind(this);
    this.onMouseMove = this.onMouseMove.bind(this);
    this.onMouseUp = this.onMouseUp.bind(this);
    
    this.handle.addEventListener('mousedown', this.onMouseDown);
  }

  onMouseDown(e) {
    this.isDragging = true;
    
    if (this.element.classList.contains('desktop-icon')) {
      this.offsetX = e.offsetX;
      this.offsetY = e.offsetY;
      this.element.classList.add('dragging');
    } else {
      const rect = this.element.getBoundingClientRect();
      this.offsetX = e.clientX - rect.left;
      this.offsetY = e.clientY - rect.top;
      this.handle.classList.add('dragging');
      bringToFront(this.element);
    }
    
    document.addEventListener('mousemove', this.onMouseMove);
    document.addEventListener('mouseup', this.onMouseUp);
  }

  onMouseMove(e) {
    if (!this.isDragging) return;
    
    if (this.element.classList.contains('desktop-icon')) {
      this.element.style.left = (e.pageX - this.offsetX) + 'px';
      this.element.style.top = (e.pageY - this.offsetY) + 'px';
    } else {
      this.element.style.left = (e.clientX - this.offsetX) + 'px';
      this.element.style.top = (e.clientY - this.offsetY) + 'px';
    }
  }

  onMouseUp() {
    this.isDragging = false;
    this.element.classList.remove('dragging');
    this.handle.classList.remove('dragging');
    document.removeEventListener('mousemove', this.onMouseMove);
    document.removeEventListener('mouseup', this.onMouseUp);
  }
}

// ============================================================================
// RESIZE FUNCTIONALITY
// ============================================================================

class ResizeHandler {
  constructor(window, handle) {
    this.window = window;
    this.handle = handle;
    this.minWidth = 260;
    this.minHeight = 180;
    
    this.handle.addEventListener('mousedown', (e) => this.startResize(e));
  }

  startResize(e) {
    e.preventDefault();
    bringToFront(this.window);
    
    const startRect = this.window.getBoundingClientRect();
    const startX = e.clientX;
    const startY = e.clientY;
    
    const onMove = (ev) => {
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      this.window.style.width = Math.max(this.minWidth, startRect.width + dx) + 'px';
      this.window.style.height = Math.max(this.minHeight, startRect.height + dy) + 'px';
    };
    
    const onUp = () => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  }
}

// ============================================================================
// KAKAOTALK FUNCTIONALITY
// ============================================================================

class KakaoTalk {
  constructor() {
    this.window = document.getElementById('kakaoWindow');
    this.icon = document.getElementById('icon');
    this.topBar = this.window.querySelector('.window-topbar');
    this.closeBtn = this.window.querySelector('.window-close-btn');
    this.typingArea = document.getElementById('typingArea');
    this.sendButton = document.getElementById('sendButton');
    this.messageContainer = document.getElementById('messageContainer');
    
    this.fuse = new Fuse(BOT_RESPONSES, { 
      keys: ["pattern"], 
      threshold: 0.4, 
      includeScore: true 
    });
    
    this.init();
  }

  init() {
    new DragHandler(this.icon);
    new DragHandler(this.window, this.topBar);
    
    this.icon.addEventListener('click', () => this.open());
    this.closeBtn.addEventListener('click', () => this.close());
    this.typingArea.addEventListener('input', () => this.updateSendButton());
    this.sendButton.addEventListener('click', () => this.sendMessage());
    this.window.addEventListener('mousedown', () => bringToFront(this.window));
    this.window.addEventListener('click', (e) => this.handleWindowClick(e));
  }

  open() {
    if (this.window.style.display === 'none' || !this.window.style.display) {
      this.window.style.display = 'block';
      bringToFront(this.window);
      this.typingArea.value = kakaoState.savedText;
      this.renderMessages();
    }
  }

  close() {
    this.window.style.display = 'none';
    kakaoState.savedText = this.typingArea.value;
    this.typingArea.value = "";
  }

  updateSendButton() {
    const hasText = this.typingArea.value.trim().length > 0;
    this.sendButton.classList.toggle('active', hasText);
    this.sendButton.disabled = !hasText;
  }

  sendMessage() {
    const text = this.typingArea.value.trim();
    if (!text) return;
    
    kakaoState.messages.push({ from: "user", text });
    this.typingArea.value = "";
    this.updateSendButton();
    this.renderMessages();
    
    setTimeout(() => {
      const reply = this.getBotReply(text);
      kakaoState.messages.push({ from: "bot", text: reply });
      this.renderMessages();
    }, 500);
  }

  getBotReply(text) {
    const results = this.fuse.search(text.toLowerCase());
    if (results.length > 0 && results[0].score < 0.4) {
      return results[0].item.reply;
    }
    return DEFAULT_REPLIES[Math.floor(Math.random() * DEFAULT_REPLIES.length)];
  }

  renderMessages() {
    this.messageContainer.innerHTML = "";
    kakaoState.messages.forEach(msg => {
      const container = document.createElement('div');
      container.className = `messageContainer ${msg.from === "user" ? 'userMsg' : 'botMsg'}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'message';
      bubble.textContent = msg.text;
      
      container.appendChild(bubble);
      this.messageContainer.appendChild(container);
    });
    this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
  }

  handleWindowClick(e) {
    const rect = this.window.getBoundingClientRect();
    const clickFromBottom = rect.height - (e.clientY - rect.top);
    if (clickFromBottom < 110) {
      this.typingArea.focus();
      bringToFront(this.window);
    }
  }
}

// ============================================================================
// NOTE WINDOW FUNCTIONALITY
// ============================================================================

class NoteWindow {
  constructor() {
    this.window = document.getElementById('noteWindow');
    this.icon = document.getElementById('noteIcon');
    this.topBar = this.window.querySelector('.window-topbar');
    this.closeBtn = this.window.querySelector('.window-close-btn');
    this.content = document.getElementById('noteContent');
    this.resizeHandle = this.window.querySelector('.resize-handle');
    
    this.init();
  }

  init() {
    new DragHandler(this.icon);
    new DragHandler(this.window, this.topBar);
    new ResizeHandler(this.window, this.resizeHandle);
    
    this.icon.addEventListener('click', () => this.open());
    this.closeBtn.addEventListener('click', () => this.close());
    this.window.addEventListener('mousedown', () => bringToFront(this.window));
    this.content.addEventListener('input', () => this.handleInput());
    this.content.addEventListener('keydown', (e) => this.handleKeydown(e));
    
    this.renderHighlights('');
    placeCaretAtEnd(this.content);
  }

  open() {
    this.window.style.display = 'block';
    bringToFront(this.window);
    placeCaretAtEnd(this.content);
  }

  close() {
    this.window.style.display = 'none';
  }

  handleInput() {
    const text = this.content.innerText.replace(/\uFEFF/g, '');
    this.renderHighlights(text);
    placeCaretAtEnd(this.content);
  }

  handleKeydown(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const text = this.content.innerText + '\t';
      this.renderHighlights(text);
      placeCaretAtEnd(this.content);
    }
  }

  renderHighlights(text) {
    this.content.innerHTML = '';
    
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const expected = TARGET_TEXT[i] ?? null;
      const span = document.createElement('span');
      span.textContent = ch;
      
      if (expected === null) {
        span.className = 'match-wrong';
      } else if (ch === expected) {
        span.className = 'match-exact';
        this.scheduleGreenFade(span);
      } else if (ch.toLowerCase() === expected.toLowerCase()) {
        span.className = 'match-case';
        this.scheduleGreenFade(span);
      } else {
        span.className = 'match-wrong';
      }
      
      this.content.appendChild(span);
    }
  }

  scheduleGreenFade(span) {
    const existingTimer = greenTimers.get(span);
    if (existingTimer) clearTimeout(existingTimer);
    
    const timer = setTimeout(() => {
      span.classList.remove('match-exact', 'match-case');
      span.style.background = 'transparent';
      greenTimers.delete(span);
    }, 5000);
    
    greenTimers.set(span, timer);
  }
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  new KakaoTalk();
  new NoteWindow();
});
</script>
</body>
</html>